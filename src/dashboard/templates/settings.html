{% extends 'base.html' %}

{% block title %}Settings - Trading Bot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-gear me-2 text-primary"></i>
        Trading Bot Settings
    </h1>
    <div>
        <button class="btn btn-outline-secondary me-2" onclick="resetSettings()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Reset
        </button>
        <button class="btn btn-success" onclick="saveSettings()">
            <i class="bi bi-check2 me-1"></i>
            Save Settings
        </button>
    </div>
</div>

<!-- Trading Mode Settings -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-toggle-on me-2"></i>
                    Trading Mode Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Current Mode:</strong> 
                    <span class="badge {% if mode_status and mode_status.mode == 'real' %}bg-warning text-dark{% else %}bg-info{% endif %} ms-2">
                        {% if mode_status and mode_status.mode == 'real' %}REAL TRADING{% else %}PAPER TRADING{% endif %}
                    </span>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Paper Trading Settings</h6>
                        <div class="mb-3">
                            <label for="paper-balance" class="form-label">Starting Paper Balance ($)</label>
                            <input type="number" class="form-control" id="paper-balance" 
                                   value="{{ settings_data.paper_balance or 1000 }}" min="100" max="100000">
                            <small class="form-text text-muted">Virtual money for testing strategies</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Real Trading Settings</h6>
                        <div class="mb-3">
                            <label for="real-investment" class="form-label">Maximum Investment ($)</label>
                            <input type="number" class="form-control" id="real-investment" 
                                   value="{{ settings_data.real_investment or 50 }}" min="1" max="10000">
                            <small class="form-text text-muted">Maximum amount to use for real trading</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-key me-2"></i>
                    API Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Security Note:</strong> API keys are stored in your .env file for security.
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Binance API Key Status</label>
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   value="{% if settings_data and settings_data.api_key_configured %}Configured{% else %}Not Set{% endif %}" 
                                   readonly>
                            <span class="input-group-text">
                                {% if settings_data and settings_data.api_key_configured %}
                                    <i class="bi bi-check-circle text-success"></i>
                                {% else %}
                                    <i class="bi bi-x-circle text-danger"></i>
                                {% endif %}
                            </span>
                        </div>
                        <small class="form-text text-muted">Set BINANCE_API_KEY in .env file</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Binance API Secret Status</label>
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   value="{% if settings_data and settings_data.api_secret_configured %}Configured{% else %}Not Set{% endif %}" 
                                   readonly>
                            <span class="input-group-text">
                                {% if settings_data and settings_data.api_secret_configured %}
                                    <i class="bi bi-check-circle text-success"></i>
                                {% else %}
                                    <i class="bi bi-x-circle text-danger"></i>
                                {% endif %}
                            </span>
                        </div>
                        <small class="form-text text-muted">Set BINANCE_API_SECRET in .env file</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Settings -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-grid-3x3-gap me-2"></i>
                    Grid DCA Strategy Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="trading-pair" class="form-label">Trading Pair</label>
                            <select class="form-select" id="trading-pair" onchange="updatePairSettings()">
                                <option value="BTCUSDT" {% if settings_data and settings_data.trading_pair == 'BTCUSDT' %}selected{% endif %}>BTC/USDT</option>
                                <option value="ETHUSDT" {% if settings_data and settings_data.trading_pair == 'ETHUSDT' %}selected{% endif %}>ETH/USDT</option>
                                <option value="ADAUSDT" {% if settings_data and settings_data.trading_pair == 'ADAUSDT' %}selected{% endif %}>ADA/USDT</option>
                                <option value="SOLUSDT" {% if settings_data and settings_data.trading_pair == 'SOLUSDT' %}selected{% endif %}>SOL/USDT</option>
                                <option value="DOGEUSDT" {% if settings_data and settings_data.trading_pair == 'DOGEUSDT' %}selected{% endif %}>DOGE/USDT</option>
                                <option value="SHIBUSDT" {% if settings_data and settings_data.trading_pair == 'SHIBUSDT' %}selected{% endif %}>SHIB/USDT</option>
                                <option value="DOTUSDT" {% if settings_data and settings_data.trading_pair == 'DOTUSDT' %}selected{% endif %}>DOT/USDT</option>
                                <option value="MATICUSDT" {% if settings_data and settings_data.trading_pair == 'MATICUSDT' %}selected{% endif %}>MATIC/USDT</option>
                                <option value="LINKUSDT" {% if settings_data and settings_data.trading_pair == 'LINKUSDT' %}selected{% endif %}>LINK/USDT</option>
                                <option value="XRPUSDT" {% if settings_data and settings_data.trading_pair == 'XRPUSDT' %}selected{% endif %}>XRP/USDT</option>
                            </select>
                            <small class="form-text text-muted">Choose which cryptocurrency to trade</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="order-size" class="form-label">Order Size ($)</label>
                            <input type="number" class="form-control" id="order-size" 
                                   value="{{ settings_data.order_size or 10 }}" min="1" max="1000" step="0.1">
                            <small class="form-text text-muted">Dollar amount per order (recommended: $5-50)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="grid-levels" class="form-label">Number of Grid Levels</label>
                            <input type="number" class="form-control" id="grid-levels" 
                                   value="{{ settings_data.grid_levels or 5 }}" min="1" max="20">
                            <small class="form-text text-muted">How many buy/sell orders to place (1-20)</small>
                        </div>

                        <div class="mb-3">
                            <label for="grid-spacing" class="form-label">Grid Spacing (%)</label>
                            <input type="number" class="form-control" id="grid-spacing" 
                                   value="{{ settings_data.grid_spacing or 2.0 }}" min="0.1" max="10" step="0.1">
                            <small class="form-text text-muted">Percentage between grid levels (0.1-10%)</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="take-profit" class="form-label">Take Profit (%)</label>
                            <input type="number" class="form-control" id="take-profit" 
                                   value="{{ settings_data.take_profit or 2 }}" min="0.1" max="10" step="0.1">
                            <small class="form-text text-muted">Profit target per trade</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="stop-loss" class="form-label">Stop Loss (%)</label>
                            <input type="number" class="form-control" id="stop-loss" 
                                   value="{{ settings_data.stop_loss or 8 }}" min="1" max="20" step="0.1">
                            <small class="form-text text-muted">Maximum loss per trade</small>
                        </div>

                        <div class="mb-3">
                            <label for="max-open-orders" class="form-label">Max Open Orders</label>
                            <input type="number" class="form-control" id="max-open-orders" 
                                   value="{{ settings_data.max_open_orders or 10 }}" min="1" max="50">
                            <small class="form-text text-muted">Maximum simultaneous orders</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Strategy Options</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-restart" 
                                       {% if settings_data and settings_data.auto_restart %}checked{% endif %}>
                                <label class="form-check-label" for="auto-restart">
                                    Auto-restart strategy after completion
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-notifications" 
                                       {% if settings_data and settings_data.enable_notifications %}checked{% endif %}>
                                <label class="form-check-label" for="enable-notifications">
                                    Enable trade notifications
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Preview Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Strategy Preview</h6>
                            <div id="strategy-preview">
                                <p><strong>Trading Pair:</strong> <span id="preview-pair">BTCUSDT</span></p>
                                <p><strong>Order Size:</strong> $<span id="preview-order-size">10.00</span> per order</p>
                                <p><strong>Grid Levels:</strong> <span id="preview-levels">5</span> levels</p>
                                <p><strong>Grid Spacing:</strong> <span id="preview-spacing">2.0</span>% between levels</p>
                                <p><strong>Total Investment:</strong> $<span id="preview-total">0.00</span> (if all orders fill)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Risk Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check me-2"></i>
                    Risk Management
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="max-daily-loss" class="form-label">Max Daily Loss ($)</label>
                            <input type="number" class="form-control" id="max-daily-loss" 
                                   value="{{ settings_data.max_daily_loss or 100 }}" min="10" max="1000">
                            <small class="form-text text-muted">Bot will stop if daily loss exceeds this amount</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="max-open-orders" class="form-label">Max Open Orders</label>
                            <input type="number" class="form-control" id="max-open-orders" 
                                   value="{{ settings_data.max_open_orders or 10 }}" min="1" max="50">
                            <small class="form-text text-muted">Maximum number of simultaneous orders</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load current settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentSettings();
    updateStrategyPreview();
    
    // Add event listeners for real-time preview updates
    ['trading-pair', 'order-size', 'grid-levels', 'grid-spacing'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateStrategyPreview);
        }
    });
});

function loadCurrentSettings() {
    fetch('/api/settings')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const settings = data.data;
            
            // Update form fields with current settings
            const fieldMappings = {
                'trading_pair': 'trading-pair',
                'order_size': 'order-size',
                'grid_levels': 'grid-levels',
                'grid_spacing': 'grid-spacing',
                'max_open_orders': 'max-open-orders',
                'take_profit': 'take-profit',
                'stop_loss': 'stop-loss',
                'paper_balance': 'paper-balance',
                'real_investment': 'real-investment',
                'max_daily_loss': 'max-daily-loss'
            };
            
            Object.entries(fieldMappings).forEach(([key, elementId]) => {
                const element = document.getElementById(elementId);
                if (element && settings[key] !== undefined) {
                    element.value = settings[key];
                }
            });
            
            // Handle checkboxes
            const checkboxes = {
                'auto_restart': 'auto-restart',
                'enable_notifications': 'enable-notifications'
            };
            
            Object.entries(checkboxes).forEach(([key, elementId]) => {
                const element = document.getElementById(elementId);
                if (element && settings[key] !== undefined) {
                    element.checked = settings[key];
                }
            });
            
            updateStrategyPreview();
            console.log('Settings loaded:', settings);
        } else {
            console.warn('Failed to load settings:', data.error);
        }
    })
    .catch(error => {
        console.error('Error loading settings:', error);
    });
}

function updatePairSettings() {
    const tradingPair = document.getElementById('trading-pair').value;
    const orderSizeInput = document.getElementById('order-size');
    
    // Adjust recommended order size based on trading pair
    const recommendations = {
        'BTCUSDT': { orderSize: 20, gridSpacing: 1.5 },
        'ETHUSDT': { orderSize: 15, gridSpacing: 2.0 },
        'ADAUSDT': { orderSize: 5, gridSpacing: 3.0 },
        'SOLUSDT': { orderSize: 10, gridSpacing: 2.5 },
        'DOGEUSDT': { orderSize: 5, gridSpacing: 3.0 },
        'SHIBUSDT': { orderSize: 3, gridSpacing: 5.0 },
        'DOTUSDT': { orderSize: 8, gridSpacing: 2.5 },
        'MATICUSDT': { orderSize: 5, gridSpacing: 3.0 },
        'LINKUSDT': { orderSize: 10, gridSpacing: 2.5 },
        'XRPUSDT': { orderSize: 5, gridSpacing: 3.0 }
    };
    
    const recommendation = recommendations[tradingPair];
    if (recommendation) {
        // Show recommendation tooltip
        showTooltip(orderSizeInput, `Recommended: $${recommendation.orderSize} for ${tradingPair}`);
        
        // Update grid spacing recommendation
        const gridSpacingInput = document.getElementById('grid-spacing');
        if (gridSpacingInput && gridSpacingInput.value == gridSpacingInput.defaultValue) {
            gridSpacingInput.value = recommendation.gridSpacing;
        }
    }
    
    updateStrategyPreview();
}

function updateStrategyPreview() {
    const tradingPair = document.getElementById('trading-pair').value;
    const orderSize = parseFloat(document.getElementById('order-size').value) || 0;
    const gridLevels = parseInt(document.getElementById('grid-levels').value) || 0;
    const gridSpacing = parseFloat(document.getElementById('grid-spacing').value) || 0;
    
    // Update preview values
    document.getElementById('preview-pair').textContent = tradingPair;
    document.getElementById('preview-order-size').textContent = orderSize.toFixed(2);
    document.getElementById('preview-levels').textContent = gridLevels;
    document.getElementById('preview-spacing').textContent = gridSpacing.toFixed(1);
    
    // Calculate total potential investment (if all buy orders fill)
    const totalInvestment = orderSize * gridLevels;
    document.getElementById('preview-total').textContent = totalInvestment.toFixed(2);
    
    // Add visual warnings
    const previewElement = document.getElementById('strategy-preview');
    previewElement.className = 'alert alert-info';
    
    if (totalInvestment > 500) {
        previewElement.className = 'alert alert-warning';
    }
    if (totalInvestment > 1000) {
        previewElement.className = 'alert alert-danger';
    }
}

function saveSettings() {
    const settings = {
        trading_pair: document.getElementById('trading-pair').value,
        order_size: document.getElementById('order-size').value,
        grid_levels: document.getElementById('grid-levels').value,
        grid_spacing: document.getElementById('grid-spacing').value,
        max_open_orders: document.getElementById('max-open-orders').value,
        take_profit: document.getElementById('take-profit').value,
        stop_loss: document.getElementById('stop-loss').value,
        paper_balance: document.getElementById('paper-balance').value,
        real_investment: document.getElementById('real-investment').value,
        max_daily_loss: document.getElementById('max-daily-loss').value,
        auto_restart: document.getElementById('auto-restart').checked,
        enable_notifications: document.getElementById('enable-notifications').checked
    };
    
    // Show loading state
    const saveBtn = document.querySelector('button[onclick="saveSettings()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
    saveBtn.disabled = true;
    
    fetch('/api/settings/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ Settings saved successfully! Restart the bot to apply changes.', 'success');
        } else {
            showAlert('❌ Failed to save settings: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('❌ Error saving settings: ' + error.message, 'danger');
    })
    .finally(() => {
        // Restore button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to default values?')) {
        // Reset to default values
        document.getElementById('trading-pair').value = 'BTCUSDT';
        document.getElementById('order-size').value = '10';
        document.getElementById('grid-levels').value = '5';
        document.getElementById('grid-spacing').value = '2.0';
        document.getElementById('max-open-orders').value = '10';
        document.getElementById('take-profit').value = '2';
        document.getElementById('stop-loss').value = '8';
        document.getElementById('paper-balance').value = '1000';
        document.getElementById('real-investment').value = '50';
        document.getElementById('max-daily-loss').value = '100';
        document.getElementById('auto-restart').checked = false;
        document.getElementById('enable-notifications').checked = true;
        
        updateStrategyPreview();
        showAlert('Settings reset to defaults. Click Save to apply.', 'info');
    }
}

function showTooltip(element, message) {
    // Simple tooltip implementation
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip fade show bs-tooltip-top';
    tooltip.innerHTML = `<div class="tooltip-inner">${message}</div>`;
    tooltip.style.position = 'absolute';
    tooltip.style.zIndex = '1070';
    
    document.body.appendChild(tooltip);
    
    setTimeout(() => {
        tooltip.remove();
    }, 3000);
}

// Show alert function
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 8000);
}
</script>
{% endblock %}