{% extends "base.html" %}

{% block title %}Grid DCA Strategy - Trading Bot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-grid-3x3-gap me-2 text-primary"></i>
        Universal Grid DCA Strategy
    </h1>
    <div class="d-flex gap-2">
        <button id="start-btn" class="btn btn-success">
            <i class="bi bi-play-fill me-1"></i>
            Start Strategy
        </button>
        <button id="stop-btn" class="btn btn-danger">
            <i class="bi bi-stop-fill me-1"></i>
            Stop Strategy
        </button>
    </div>
</div>

<!-- Strategy Status -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-activity fs-2 me-3 text-primary"></i>
                <div>
                    <div id="strategy-status" class="metric-value {% if strategy_data and strategy_data.status.status == 'active' %}status-running{% else %}status-stopped{% endif %}">
                        {{ strategy_data.status.status|title if strategy_data and strategy_data.status else 'Inactive' }}
                    </div>
                    <div class="metric-label">Strategy Status</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-wallet2 fs-2 me-3 text-success"></i>
                <div>
                    <div id="investment-amount" class="metric-value">${{ "%.2f"|format(strategy_data.summary.balance or 0) if strategy_data else '0.00' }}</div>
                    <div class="metric-label">Investment Amount</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-layers fs-2 me-3 text-info"></i>
                <div>
                    <div id="grid-levels" class="metric-value">{{ strategy_data.summary.active_orders or 0 if strategy_data else 0 }}</div>
                    <div class="metric-label">Active Orders</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-percent fs-2 me-3 text-warning"></i>
                <div>
                    <div id="current-profit" class="metric-value" style="color: {% if strategy_data and strategy_data.summary.total_profit >= 0 %}var(--success-color){% else %}var(--danger-color){% endif %}">${{ "%.2f"|format(strategy_data.summary.total_profit or 0) if strategy_data else '0.00' }}</div>
                    <div class="metric-label">Current P&L</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Configuration -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear-fill me-2"></i>
                    Strategy Configuration
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Symbol:</strong></td>
                        <td id="config-symbol">{{ strategy_data.status.symbol if strategy_data and strategy_data.status else 'BTC/USDT' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Take Profit:</strong></td>
                        <td id="config-tp">{{ strategy_data.status.take_profit if strategy_data and strategy_data.status else 2 }}%</td>
                    </tr>
                    <tr>
                        <td><strong>Stop Loss:</strong></td>
                        <td id="config-sl">{{ strategy_data.status.stop_loss if strategy_data and strategy_data.status else 8 }}%</td>
                    </tr>
                    <tr>
                        <td><strong>Grid Spacing:</strong></td>
                        <td id="config-spacing">{{ strategy_data.status.grid_spacing if strategy_data and strategy_data.status else 1 }}%</td>
                    </tr>
                    <tr>
                        <td><strong>Order Size:</strong></td>
                        <td id="config-ordersize">$0.00</td>
                    </tr>
                    <tr>
                        <td><strong>Win Rate Target:</strong></td>
                        <td id="config-winrate">89.5%</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart me-2"></i>
                    Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Total Trades:</strong></td>
                        <td id="perf-trades">0</td>
                    </tr>
                    <tr>
                        <td><strong>Winning Trades:</strong></td>
                        <td id="perf-wins">0</td>
                    </tr>
                    <tr>
                        <td><strong>Actual Win Rate:</strong></td>
                        <td id="perf-winrate">0%</td>
                    </tr>
                    <tr>
                        <td><strong>Total Profit:</strong></td>
                        <td id="perf-profit">$0.00</td>
                    </tr>
                    <tr>
                        <td><strong>Average Trade:</strong></td>
                        <td id="perf-avgtrade">$0.00</td>
                    </tr>
                    <tr>
                        <td><strong>Max Drawdown:</strong></td>
                        <td id="perf-drawdown">0%</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Active Orders -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Active Grid Orders
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            {% if strategy_data and strategy_data.orders and strategy_data.orders|length > 0 %}
                                {% for order in strategy_data.orders %}
                                <tr>
                                    <td><span class="badge bg-primary">Level {{ order.level or loop.index }}</span></td>
                                    <td><span class="badge {% if order.type == 'buy' %}bg-success{% else %}bg-danger{% endif %}">{{ order.type|upper if order.type else 'N/A' }}</span></td>
                                    <td>${{ "%.4f"|format(order.price or 0) }}</td>
                                    <td>{{ "%.6f"|format(order.amount or 0) }}</td>
                                    <td>${{ "%.2f"|format(order.usd_amount or 0) }}</td>
                                    <td><span class="badge bg-warning">{{ order.status|upper if order.status else 'PENDING' }}</span></td>
                                    <td>{{ order.created.strftime('%H:%M:%S') if order.created else 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox me-2"></i>
                                    No active orders
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Grid Trades -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Recent Grid Trades
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Level</th>
                                <th>Side</th>
                                <th>Amount</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table">
                            {% if strategy_data and strategy_data.trades and strategy_data.trades|length > 0 %}
                                {% for trade in strategy_data.trades %}
                                <tr>
                                    <td>{{ trade.timestamp.strftime('%Y-%m-%d %H:%M:%S') if trade.timestamp else 'N/A' }}</td>
                                    <td><span class="badge bg-info">Level {{ loop.index }}</span></td>
                                    <td><span class="badge {% if trade.type == 'buy' %}bg-success{% else %}bg-danger{% endif %}">{{ trade.type|upper if trade.type else 'N/A' }}</span></td>
                                    <td>{{ "%.6f"|format(trade.amount or 0) }}</td>
                                    <td>${{ "%.4f"|format(trade.price or 0) }}</td>
                                    <td>${{ "%.2f"|format(trade.usd_amount or 0) }}</td>
                                    <td class="{% if trade.profit and trade.profit >= 0 %}text-success{% else %}text-danger{% endif %}">${{ "%.2f"|format(trade.profit or 0) }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox me-2"></i>
                                    No trades yet
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let strategyData = {};

// Load strategy data
async function loadStrategyData() {
    try {
        const response = await fetch('/api/grid-dca/status');
        const data = await response.json();
        strategyData = data;
        updateStrategyDisplay(data);
    } catch (error) {
        console.error('Error loading strategy data:', error);
        showAlert('Failed to load strategy data', 'danger');
    }
}

// Update strategy display
function updateStrategyDisplay(data) {
    // Status
    const status = data.status || 'inactive';
    document.getElementById('strategy-status').textContent = status.charAt(0).toUpperCase() + status.slice(1);
    document.getElementById('strategy-status').className = `metric-value status-${status === 'active' ? 'running' : 'stopped'}`;
    
    // Investment and metrics
    document.getElementById('investment-amount').textContent = formatCurrency(data.investment_amount || 0);
    document.getElementById('grid-levels').textContent = data.grid_levels || 0;
    
    const currentProfit = data.current_profit || 0;
    const profitElement = document.getElementById('current-profit');
    profitElement.textContent = formatCurrency(currentProfit);
    profitElement.style.color = currentProfit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
    
    // Configuration
    if (data.config) {
        document.getElementById('config-symbol').textContent = data.config.symbol || 'BTC/USDT';
        document.getElementById('config-tp').textContent = `${data.config.take_profit || 2}%`;
        document.getElementById('config-sl').textContent = `${data.config.stop_loss || 8}%`;
        document.getElementById('config-spacing').textContent = `${data.config.grid_spacing || 1}%`;
        document.getElementById('config-ordersize').textContent = formatCurrency(data.config.order_size || 0);
        document.getElementById('config-winrate').textContent = `${data.config.win_rate || 89.5}%`;
    }
    
    // Performance
    if (data.performance) {
        document.getElementById('perf-trades').textContent = data.performance.total_trades || 0;
        document.getElementById('perf-wins').textContent = data.performance.winning_trades || 0;
        document.getElementById('perf-winrate').textContent = `${(data.performance.win_rate || 0).toFixed(1)}%`;
        
        const totalProfit = data.performance.total_profit || 0;
        const totalProfitElement = document.getElementById('perf-profit');
        totalProfitElement.textContent = formatCurrency(totalProfit);
        totalProfitElement.style.color = totalProfit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        
        document.getElementById('perf-avgtrade').textContent = formatCurrency(data.performance.avg_trade || 0);
        document.getElementById('perf-drawdown').textContent = `${(data.performance.max_drawdown || 0).toFixed(1)}%`;
    }
    
    // Active orders
    updateOrdersTable(data.active_orders || []);
    
    // Recent trades
    updateTradesTable(data.recent_trades || []);
}

function updateOrdersTable(orders) {
    const ordersTable = document.getElementById('orders-table');
    
    if (orders.length > 0) {
        ordersTable.innerHTML = orders.map(order => `
            <tr>
                <td><span class="badge bg-primary">Level ${order.level || 'N/A'}</span></td>
                <td><span class="badge ${order.side === 'buy' ? 'bg-success' : 'bg-danger'}">${(order.side || '').toUpperCase()}</span></td>
                <td>${formatCurrency(order.price || 0)}</td>
                <td>${parseFloat(order.amount || 0).toFixed(6)}</td>
                <td>${formatCurrency(order.total || 0)}</td>
                <td><span class="badge bg-warning">PENDING</span></td>
                <td>${formatDate(order.created_at || new Date())}</td>
            </tr>
        `).join('');
    } else {
        ordersTable.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox me-2"></i>
                    No active orders
                </td>
            </tr>
        `;
    }
}

function updateTradesTable(trades) {
    const tradesTable = document.getElementById('trades-table');
    
    if (trades.length > 0) {
        tradesTable.innerHTML = trades.map(trade => {
            const pnl = trade.pnl || 0;
            const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
            
            return `
                <tr>
                    <td>${formatDate(trade.timestamp)}</td>
                    <td><span class="badge bg-info">Level ${trade.level || 'N/A'}</span></td>
                    <td><span class="badge ${trade.side === 'buy' ? 'bg-success' : 'bg-danger'}">${(trade.side || '').toUpperCase()}</span></td>
                    <td>${parseFloat(trade.amount || 0).toFixed(6)}</td>
                    <td>${formatCurrency(trade.price || 0)}</td>
                    <td>${formatCurrency(trade.total || 0)}</td>
                    <td class="${pnlClass}">${formatCurrency(pnl)}</td>
                </tr>
            `;
        }).join('');
    } else {
        tradesTable.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox me-2"></i>
                    No trades yet
                </td>
            </tr>
        `;
    }
}

// Bot control functions
async function startBot() {
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    
    startBtn.disabled = true;
    startBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';
    
    try {
        const response = await fetch('/api/start', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showAlert('Bot started successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            throw new Error(data.message || 'Failed to start bot');
        }
    } catch (error) {
        console.error('Error starting bot:', error);
        showAlert('Failed to start bot: ' + error.message, 'danger');
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-play-fill me-2"></i>Start Bot';
    }
}

async function stopBot() {
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    
    stopBtn.disabled = true;
    stopBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Stopping...';
    
    try {
        const response = await fetch('/api/stop', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showAlert('Bot stopped successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            throw new Error(data.message || 'Failed to stop bot');
        }
    } catch (error) {
        console.error('Error stopping bot:', error);
        showAlert('Failed to stop bot: ' + error.message, 'danger');
        stopBtn.disabled = false;
        stopBtn.innerHTML = '<i class="bi bi-stop-fill me-2"></i>Stop Bot';
    }
}

// Auto-refresh every 30 seconds
setInterval(() => {
    window.location.reload();
}, 30000);
</script>
{% endblock %}
