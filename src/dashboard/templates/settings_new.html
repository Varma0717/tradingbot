{% extends 'base.html' %}

{% block title %}
  Settings - Crypto Trading Bot
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', path='css/settings.css') }}" />
{% endblock %}

{% block content %}
  <div class="settings-container">
    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
          <div class="settings-card">
            <!-- Header -->
            <div class="settings-header">
              <h1><i class="bi bi-gear-fill me-3"></i>Trading Bot Settings</h1>
              <p class="mb-0 mt-2 opacity-75">Configure your trading bot for optimal performance</p>
            </div>

            <!-- Navigation Tabs -->
            <div class="settings-nav">
              <ul class="nav nav-tabs nav-fill" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button"><i class="bi bi-speedometer2 me-2"></i>Overview</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading" type="button"><i class="bi bi-graph-up me-2"></i>Trading</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="exchange-tab" data-bs-toggle="tab" data-bs-target="#exchange" type="button"><i class="bi bi-bank me-2"></i>Exchange</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk" type="button"><i class="bi bi-shield-check me-2"></i>Risk Management</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button"><i class="bi bi-bell me-2"></i>Notifications</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button"><i class="bi bi-cpu me-2"></i>Advanced</button>
                </li>
              </ul>
            </div>

            <!-- Tab Content -->
            <div class="settings-content">
              <div class="tab-content" id="settingsTabContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Welcome to Trading Bot Settings!</strong> Configure your bot parameters to optimize trading performance.
                  </div>

                  <!-- Status Overview -->
                  <div class="form-section">
                    <h5><i class="bi bi-activity me-2"></i>Bot Status Overview</h5>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="status-indicator status-connected">
                          <i class="bi bi-check-circle me-2"></i>
                          Bot Status: <span id="botStatusOverview">Running</span>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="status-indicator status-connected">
                          <i class="bi bi-wifi me-2"></i>
                          Exchange: <span id="exchangeStatusOverview">Connected</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Quick Settings -->
                  <div class="form-section">
                    <h5><i class="bi bi-lightning me-2"></i>Quick Settings</h5>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Trading Mode</label>
                        <select class="form-select" id="tradingModeQuick">
                          <option value="paper">Paper Trading</option>
                          <option value="live">Live Trading</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Strategy</label>
                        <select class="form-select" id="strategyQuick">
                          <option value="grid_dca">Grid DCA Strategy</option>
                          <option value="ma_crossover">MA Crossover</option>
                          <option value="rsi_strategy">RSI Strategy</option>
                        </select>
                      </div>
                    </div>
                    <div class="mt-3">
                      <button class="btn btn-primary" onclick="applyQuickSettings()"><i class="bi bi-lightning-fill me-2"></i>Apply Quick Settings</button>
                    </div>
                  </div>
                </div>

                <!-- Trading Tab -->
                <div class="tab-pane fade" id="trading" role="tabpanel">
                  <div class="form-section">
                    <h5><i class="bi bi-graph-up me-2"></i>Trading Configuration</h5>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Trading Mode</label>
                        <select class="form-select" id="tradingMode" name="trading_mode">
                          <option value="paper">Paper Trading (Simulation)</option>
                          <option value="live">Live Trading (Real Money)</option>
                        </select>
                        <div class="form-text">Paper mode uses simulated funds for testing strategies safely.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Primary Symbol</label>
                        <input type="text" class="form-control" id="primarySymbol" name="primary_symbol" value="BTC/USDT" />
                        <div class="form-text">The main trading pair for your bot.</div>
                      </div>
                    </div>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Base Investment Amount</label>
                        <input type="number" class="form-control" id="baseAmount" name="base_amount" value="100" min="10" step="10" />
                        <div class="form-text">Amount to allocate per trade in USDT.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Maximum Concurrent Trades</label>
                        <input type="number" class="form-control" id="maxTrades" name="max_trades" value="5" min="1" max="20" />
                        <div class="form-text">Maximum number of simultaneous open positions.</div>
                      </div>
                    </div>

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="enableStopLoss" name="enable_stop_loss" />
                      <label class="form-check-label" for="enableStopLoss">Enable Stop Loss Protection</label>
                    </div>
                  </div>

                  <!-- Strategy Configuration -->
                  <div class="form-section">
                    <h5><i class="bi bi-cpu me-2"></i>Strategy Parameters</h5>

                    <div class="row g-3 mb-3">
                      <div class="col-md-4">
                        <label class="form-label">Strategy Type</label>
                        <select class="form-select" id="strategyType" name="strategy_type">
                          <option value="grid_dca">Grid Trading + DCA</option>
                          <option value="ma_crossover">Moving Average Crossover</option>
                          <option value="rsi_strategy">RSI Strategy</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Timeframe</label>
                        <select class="form-select" id="timeframe" name="timeframe">
                          <option value="1m">1 Minute</option>
                          <option value="5m">5 Minutes</option>
                          <option value="15m">15 Minutes</option>
                          <option value="1h" selected>1 Hour</option>
                          <option value="4h">4 Hours</option>
                          <option value="1d">1 Day</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Take Profit %</label>
                        <input type="number" class="form-control" id="takeProfitPct" name="take_profit_pct" value="2.5" min="0.1" max="20" step="0.1" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Exchange Tab -->
                <div class="tab-pane fade" id="exchange" role="tabpanel">
                  <div class="form-section">
                    <h5><i class="bi bi-bank me-2"></i>Exchange Configuration</h5>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Exchange</label>
                        <select class="form-select" id="exchange" name="exchange">
                          <option value="binance">Binance</option>
                          <option value="coinbase">Coinbase Pro</option>
                          <option value="kraken">Kraken</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Environment</label>
                        <select class="form-select" id="environment" name="environment">
                          <option value="testnet">Testnet (Paper Trading)</option>
                          <option value="live">Live (Real Trading)</option>
                        </select>
                      </div>
                    </div>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-control" id="apiKey" name="api_key" placeholder="Enter your API key" />
                        <div class="form-text">Your exchange API key (kept secure).</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">API Secret</label>
                        <input type="password" class="form-control" id="apiSecret" name="api_secret" placeholder="Enter your API secret" />
                        <div class="form-text">Your exchange API secret (encrypted).</div>
                      </div>
                    </div>

                    <div class="alert alert-warning">
                      <i class="bi bi-shield-exclamation me-2"></i>
                      <strong>Security Note:</strong> API credentials are encrypted and stored securely. Never share your API keys.
                    </div>

                    <button class="btn btn-primary" onclick="testConnection()"><i class="bi bi-wifi me-2"></i>Test Connection</button>
                  </div>
                </div>

                <!-- Risk Management Tab -->
                <div class="tab-pane fade" id="risk" role="tabpanel">
                  <div class="form-section">
                    <h5><i class="bi bi-shield-check me-2"></i>Risk Management</h5>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Maximum Daily Loss (%)</label>
                        <input type="number" class="form-control" id="maxDailyLoss" name="max_daily_loss" value="5" min="1" max="20" step="0.5" />
                        <div class="form-text">Bot stops trading if daily loss exceeds this percentage.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Maximum Portfolio Risk (%)</label>
                        <input type="number" class="form-control" id="maxPortfolioRisk" name="max_portfolio_risk" value="10" min="1" max="50" step="1" />
                        <div class="form-text">Maximum percentage of portfolio at risk at any time.</div>
                      </div>
                    </div>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Stop Loss Percentage</label>
                        <input type="number" class="form-control" id="stopLossPct" name="stop_loss_pct" value="3" min="0.5" max="15" step="0.1" />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Position Size (%)</label>
                        <input type="number" class="form-control" id="positionSize" name="position_size" value="2" min="0.5" max="10" step="0.1" />
                        <div class="form-text">Percentage of portfolio per position.</div>
                      </div>
                    </div>

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="enableEmergencyStop" name="enable_emergency_stop" checked />
                      <label class="form-check-label" for="enableEmergencyStop">Enable Emergency Stop (Circuit Breaker)</label>
                    </div>
                  </div>
                </div>

                <!-- Notifications Tab -->
                <div class="tab-pane fade" id="notifications" role="tabpanel">
                  <div class="form-section">
                    <h5><i class="bi bi-bell me-2"></i>Notification Settings</h5>

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="enableEmailNotifications" name="enable_email" checked />
                      <label class="form-check-label" for="enableEmailNotifications">Enable Email Notifications</label>
                    </div>

                    <div class="row g-3 mb-3">
                      <div class="col-md-12">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="notificationEmail" name="notification_email" placeholder="your@email.com" />
                      </div>
                    </div>

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="notifyTrades" name="notify_trades" checked />
                      <label class="form-check-label" for="notifyTrades">Notify on Trade Execution</label>
                    </div>

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="notifyErrors" name="notify_errors" checked />
                      <label class="form-check-label" for="notifyErrors">Notify on Errors</label>
                    </div>

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="notifyProfitLoss" name="notify_profit_loss" />
                      <label class="form-check-label" for="notifyProfitLoss">Daily P&L Summary</label>
                    </div>
                  </div>
                </div>

                <!-- Advanced Tab -->
                <div class="tab-pane fade" id="advanced" role="tabpanel">
                  <div class="form-section">
                    <h5><i class="bi bi-cpu me-2"></i>Advanced Configuration</h5>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label">Update Frequency (seconds)</label>
                        <input type="number" class="form-control" id="updateFrequency" name="update_frequency" value="30" min="5" max="300" />
                        <div class="form-text">How often the bot checks for new signals.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Log Level</label>
                        <select class="form-select" id="logLevel" name="log_level">
                          <option value="DEBUG">Debug</option>
                          <option value="INFO" selected>Info</option>
                          <option value="WARNING">Warning</option>
                          <option value="ERROR">Error</option>
                        </select>
                      </div>
                    </div>

                    <div class="advanced-section">
                      <h6>Database Settings</h6>
                      <div class="row g-3 mb-3">
                        <div class="col-md-6">
                          <label class="form-label">Database Host</label>
                          <input type="text" class="form-control" id="dbHost" name="db_host" value="localhost" />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Database Port</label>
                          <input type="number" class="form-control" id="dbPort" name="db_port" value="3306" />
                        </div>
                      </div>
                    </div>

                    <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" id="enableDebugMode" name="enable_debug" />
                      <label class="form-check-label" for="enableDebugMode">Enable Debug Mode</label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Save Controls -->
              <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
                <div>
                  <button class="btn btn-outline-secondary" onclick="resetToDefaults()"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Defaults</button>
                </div>
                <div>
                  <button class="btn btn-success me-2" onclick="saveSettings()"><i class="bi bi-check-lg me-2"></i>Save Settings</button>
                  <button class="btn btn-primary" onclick="saveAndRestart()"><i class="bi bi-arrow-repeat me-2"></i>Save & Restart Bot</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Indicator -->
  <div class="save-indicator" id="saveIndicator">
    <i class="bi bi-check-circle me-2"></i>Settings saved successfully!
  </div>

  <script>
    // Settings functionality
    document.addEventListener('DOMContentLoaded', function () {
      loadCurrentSettings()
    
      // Auto-save on change
      const formInputs = document.querySelectorAll('input, select')
      formInputs.forEach((input) => {
        input.addEventListener('change', function () {
          if (this.dataset.autoSave !== 'false') {
            autoSaveSettings()
          }
        })
      })
    })
    
    async function loadCurrentSettings() {
      try {
        const response = await fetch('/api/settings')
        if (response.ok) {
          const settings = await response.json()
          populateForm(settings)
          updateStatusIndicators(settings)
        }
      } catch (error) {
        console.error('Error loading settings:', error)
        showNotification('Error loading current settings', 'error')
      }
    }
    
    function populateForm(settings) {
      // Populate form fields with current settings
      Object.keys(settings).forEach((key) => {
        const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`)
        if (element) {
          if (element.type === 'checkbox') {
            element.checked = settings[key]
          } else {
            element.value = settings[key]
          }
        }
      })
    }
    
    function updateStatusIndicators(settings) {
      // Update status indicators
      const botStatus = document.getElementById('botStatusOverview')
      const exchangeStatus = document.getElementById('exchangeStatusOverview')
    
      if (botStatus) {
        botStatus.textContent = settings.bot_running ? 'Running' : 'Stopped'
        botStatus.parentElement.className = settings.bot_running ? 'status-indicator status-connected' : 'status-indicator status-disconnected'
      }
    
      if (exchangeStatus) {
        exchangeStatus.textContent = settings.exchange_connected ? 'Connected' : 'Disconnected'
        exchangeStatus.parentElement.className = settings.exchange_connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected'
      }
    }
    
    async function saveSettings() {
      const formData = collectFormData()
    
      try {
        showLoadingState(true)
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
    
        if (response.ok) {
          showSaveIndicator()
          showNotification('Settings saved successfully!', 'success')
        } else {
          const error = await response.json()
          showNotification(`Error saving settings: ${error.detail}`, 'error')
        }
      } catch (error) {
        console.error('Error saving settings:', error)
        showNotification('Error saving settings. Please try again.', 'error')
      } finally {
        showLoadingState(false)
      }
    }
    
    async function saveAndRestart() {
      await saveSettings()
    
      try {
        const response = await fetch('/api/control/restart', { method: 'POST' })
        if (response.ok) {
          showNotification('Bot restarted with new settings!', 'success')
          setTimeout(() => location.reload(), 2000)
        }
      } catch (error) {
        showNotification('Settings saved, but restart failed. Please restart manually.', 'warning')
      }
    }
    
    function collectFormData() {
      const formData = {}
      const inputs = document.querySelectorAll('input, select')
    
      inputs.forEach((input) => {
        const name = input.name || input.id
        if (name) {
          if (input.type === 'checkbox') {
            formData[name] = input.checked
          } else {
            formData[name] = input.value
          }
        }
      })
    
      return formData
    }
    
    function showSaveIndicator() {
      const indicator = document.getElementById('saveIndicator')
      indicator.classList.add('show')
      setTimeout(() => {
        indicator.classList.remove('show')
      }, 3000)
    }
    
    function showLoadingState(show) {
      const buttons = document.querySelectorAll('.btn')
      buttons.forEach((btn) => {
        if (show) {
          btn.disabled = true
          if (btn.querySelector('.loading-spinner')) return
          btn.insertAdjacentHTML('afterbegin', '<span class="loading-spinner"></span>')
        } else {
          btn.disabled = false
          const spinner = btn.querySelector('.loading-spinner')
          if (spinner) spinner.remove()
        }
      })
    }
    
    async function testConnection() {
      try {
        showLoadingState(true)
        const response = await fetch('/api/exchange/test-connection', { method: 'POST' })
        const result = await response.json()
    
        if (result.success) {
          showNotification('Exchange connection successful!', 'success')
        } else {
          showNotification(`Connection failed: ${result.message}`, 'error')
        }
      } catch (error) {
        showNotification('Connection test failed. Please check your settings.', 'error')
      } finally {
        showLoadingState(false)
      }
    }
    
    function applyQuickSettings() {
      const mode = document.getElementById('tradingModeQuick').value
      const strategy = document.getElementById('strategyQuick').value
    
      // Apply quick settings to main form
      document.getElementById('tradingMode').value = mode
      document.getElementById('strategyType').value = strategy
    
      // Switch to trading tab
      document.getElementById('trading-tab').click()
    
      showNotification('Quick settings applied! Review and save changes.', 'success')
    }
    
    function resetToDefaults() {
      if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
        // Reset form to default values
        const form = document.querySelector('.settings-content')
        form.reset()
        showNotification('Settings reset to defaults. Remember to save changes.', 'warning')
      }
    }
    
    async function autoSaveSettings() {
      // Auto-save without showing notifications
      const formData = collectFormData()
    
      try {
        await fetch('/api/settings/auto-save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
      } catch (error) {
        console.error('Auto-save failed:', error)
      }
    }
    
    // Notification system (if not available from base template)
    function showNotification(message, type = 'info') {
      if (typeof window.showNotification === 'function') {
        window.showNotification(message, type)
      } else {
        alert(message) // Fallback
      }
    }
  </script>
{% endblock %}
