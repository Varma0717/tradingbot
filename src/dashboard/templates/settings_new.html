{% extends 'base.html' %}

{% block title %}
  Settings - Trading Bot
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="bi bi-gear me-2 text-primary"></i>
      Bot Settings
    </h1>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="exportSettings()">
        <i class="bi bi-download me-1"></i>
        Export
      </button>
      <button class="btn btn-success" onclick="saveSettings()">
        <i class="bi bi-check2 me-1"></i>
        Save Settings
      </button>
    </div>
  </div>

  <!-- Settings Form -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-sliders me-2"></i>
            Trading Configuration
          </h5>
        </div>
        <div class="card-body">
          <form id="settings-form">
            <!-- API Settings -->
            <div class="row mb-4">
              <div class="col-md-12">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>API Configuration Status:</strong>
                  {% if settings_data.api_key_configured and settings_data.api_secret_configured %}
                    ✅ API keys are configured from .env file
                  {% else %}
                    ❌ API keys need to be configured in .env file
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <label for="api-key" class="form-label">API Key Status</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="api-key" 
                         value="{{ settings_data.api_key or 'Not configured' }}" 
                         readonly>
                  <span class="input-group-text">
                    {% if settings_data.api_key_configured %}
                      <i class="bi bi-check-circle text-success"></i>
                    {% else %}
                      <i class="bi bi-x-circle text-danger"></i>
                    {% endif %}
                  </span>
                </div>
                <small class="form-text text-muted">Configure in .env file: BINANCE_API_KEY</small>
              </div>
              <div class="col-md-6">
                <label for="api-secret" class="form-label">API Secret Status</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="api-secret" 
                         value="{{ settings_data.api_secret or 'Not configured' }}" 
                         readonly>
                  <span class="input-group-text">
                    {% if settings_data.api_secret_configured %}
                      <i class="bi bi-check-circle text-success"></i>
                    {% else %}
                      <i class="bi bi-x-circle text-danger"></i>
                    {% endif %}
                  </span>
                </div>
                <small class="form-text text-muted">Configure in .env file: BINANCE_API_SECRET</small>
              </div>
            </div>

            <!-- Trading Pair -->
            <div class="row mb-4">
              <div class="col-md-6">
                <label for="trading-pair" class="form-label">Trading Pair</label>
                <select class="form-select" id="trading-pair">
                  <option value="BTC/USDT" {% if settings_data.trading_pair == 'BTC/USDT' %}selected{% endif %}>BTC/USDT</option>
                  <option value="ETH/USDT" {% if settings_data.trading_pair == 'ETH/USDT' %}selected{% endif %}>ETH/USDT</option>
                  <option value="BNB/USDT" {% if settings_data.trading_pair == 'BNB/USDT' %}selected{% endif %}>BNB/USDT</option>
                  <option value="ADA/USDT" {% if settings_data.trading_pair == 'ADA/USDT' %}selected{% endif %}>ADA/USDT</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="balance-allocation" class="form-label">Balance Allocation (%)</label>
                <input type="number" class="form-control" id="balance-allocation" value="{{ settings_data.balance_allocation or 10 }}" min="1" max="100">
              </div>
            </div>

            <!-- Risk Management -->
            <div class="row mb-4">
              <div class="col-md-6">
                <label for="risk-level" class="form-label">Risk Level</label>
                <select class="form-select" id="risk-level">
                  <option value="low" {% if settings_data.risk_level == 'low' %}selected{% endif %}>Low Risk</option>
                  <option value="medium" {% if settings_data.risk_level == 'medium' %}selected{% endif %}>Medium Risk</option>
                  <option value="high" {% if settings_data.risk_level == 'high' %}selected{% endif %}>High Risk</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="auto-compound" {% if settings_data.auto_compound %}checked{% endif %}>
                  <label class="form-check-label" for="auto-compound">
                    Auto-compound profits
                  </label>
                </div>
              </div>
            </div>

            <!-- Safety Features -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="stop-loss-enabled" {% if settings_data.stop_loss_enabled %}checked{% endif %}>
                  <label class="form-check-label" for="stop-loss-enabled">
                    Enable Stop Loss
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="notifications-enabled" {% if settings_data.notifications_enabled %}checked{% endif %}>
                  <label class="form-check-label" for="notifications-enabled">
                    Enable Notifications
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Strategy Info -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Universal Strategy Info
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <strong>Strategy Type:</strong>
            <span class="badge bg-primary ms-2">Universal Grid DCA</span>
          </div>
          <div class="mb-3">
            <strong>Win Rate:</strong>
            <span class="text-success">89.5%</span>
          </div>
          <div class="mb-3">
            <strong>Take Profit:</strong>
            <span class="text-info">2.0%</span>
          </div>
          <div class="mb-3">
            <strong>Stop Loss:</strong>
            <span class="text-warning">8.0%</span>
          </div>
          <div class="mb-3">
            <strong>Grid Spacing:</strong>
            <span class="text-muted">1.0%</span>
          </div>
          <hr>
          <button class="btn btn-warning w-100" onclick="testConnection()">
            <i class="bi bi-wifi me-1"></i>
            Test Connection
          </button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card mt-3">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning me-2"></i>
            Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <button class="btn btn-outline-secondary w-100 mb-2" onclick="resetSettings()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Reset to Defaults
          </button>
          <button class="btn btn-outline-info w-100">
            <i class="bi bi-question-circle me-1"></i>
            Help & Documentation
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
function saveSettings() {
    showAlert('Settings saved successfully!', 'success');
}

function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to default values?')) {
        window.location.reload();
        showAlert('Settings reset to defaults', 'info');
    }
}

function exportSettings() {
    const settings = {
        api_key: document.getElementById('api-key').value,
        api_secret: 'hidden',
        trading_pair: document.getElementById('trading-pair').value,
        balance_allocation: document.getElementById('balance-allocation').value,
        risk_level: document.getElementById('risk-level').value,
        auto_compound: document.getElementById('auto-compound').checked,
        stop_loss_enabled: document.getElementById('stop-loss-enabled').checked,
        notifications_enabled: document.getElementById('notifications-enabled').checked
    };
    
    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'trading_bot_settings.json';
    link.click();
    URL.revokeObjectURL(url);
    
    showAlert('Settings exported successfully!', 'success');
}

function testConnection() {
    const testBtn = document.querySelector('.btn-warning');
    const originalText = testBtn.innerHTML;
    
    testBtn.disabled = true;
    testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Testing...';
    
    // Simulate API test
    setTimeout(() => {
        testBtn.disabled = false;
        testBtn.innerHTML = originalText;
        showAlert('Connection test successful!', 'success');
    }, 2000);
}
</script>
{% endblock %}
