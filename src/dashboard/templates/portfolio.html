{% extends 'base.html' %}

{% block title %}
  Portfolio - Trading Bot
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="bi bi-wallet2 me-2 text-primary"></i>
      Portfolio Overview
    </h1>
    <button class="btn btn-primary" onclick="refreshPortfolio()">
      <i class="bi bi-arrow-clockwise me-1"></i>
      Refresh
    </button>
  </div>

  <!-- Portfolio Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="metric-card">
        <div class="d-flex align-items-center">
          <i class="bi bi-currency-dollar fs-2 me-3 text-success"></i>
          <div>
            <div id="total-balance" class="metric-value">${{ '%.2f'|format(portfolio_data.total_balance or 0) }}</div>
            <div class="metric-label">Total Balance</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="metric-card">
        <div class="d-flex align-items-center">
          <i class="bi bi-bank fs-2 me-3 text-primary"></i>
          <div>
            <div id="available-balance" class="metric-value">${{ '%.2f'|format(portfolio_data.available_balance or 0) }}</div>
            <div class="metric-label">Available Balance</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="metric-card">
        <div class="d-flex align-items-center">
          <i class="bi bi-lock fs-2 me-3 text-warning"></i>
          <div>
            <div id="locked-balance" class="metric-value">${{ '%.2f'|format(portfolio_data.locked_balance or 0) }}</div>
            <div class="metric-label">Locked in Orders</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="metric-card">
        <div class="d-flex align-items-center">
          <i class="bi bi-graph-up fs-2 me-3 text-info"></i>
          <div>
            <div id="total-pnl"
              class="metric-value"
              style="color: {% if portfolio_data.unrealized_pnl and portfolio_data.unrealized_pnl >= 0 %}
                
                var(--success-color)

              {% else %}
                
                var(--danger-color)

              {% endif %}">${{ '%.2f'|format(portfolio_data.unrealized_pnl or 0) }}</div>
            <div class="metric-label">Total P&L</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Holdings Table -->
  <div class="card">
    <div class="card-header">
      <h5 class="card-title mb-0">
        <i class="bi bi-pie-chart me-2"></i>
        Holdings
      </h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Asset</th>
              <th>Amount</th>
              <th>Value (USD)</th>
              <th>Allocation</th>
              <th>24h Change</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="holdings-table">
            {% if portfolio_data.positions and portfolio_data.positions|length > 0 %}
              {% for position in portfolio_data.positions %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <strong>{{ position.symbol or 'N/A' }}</strong>
                      <small class="text-muted ms-2">{{ position.name or '' }}</small>
                    </div>
                  </td>
                  <td>{{ '%.6f'|format(position.amount or 0) }}</td>
                  <td>${{ '%.2f'|format(position.value_usd or 0) }}</td>
                  <td>
                    <div class="progress" style="height: 6px;">
                      <div class="progress-bar" style="width: {{ position.allocation or 0 }}%"></div>
                    </div>
                    <small>{{ '%.1f'|format(position.allocation or 0) }}%</small>
                  </td>
                  <td>
                    <span class="badge {% if position.change_24h and position.change_24h >= 0 %}
                        
                        bg-success

                      {% else %}
                        
                        bg-danger

                      {% endif %}">
                      {% if position.change_24h and position.change_24h >= 0 %}+{% endif %}{{ '%.2f'|format(position.change_24h or 0) }}%
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="tradeAsset('{{ position.symbol }}')"><i class="bi bi-arrow-left-right"></i></button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  <i class="bi bi-inbox me-2"></i>
                  No holdings found
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    function refreshPortfolio() {
      showAlert('Refreshing portfolio data...', 'info')
      window.location.reload()
    }
    
    function tradeAsset(symbol) {
      window.location.href = `/grid-dca?symbol=${symbol}`
    }
    
    // Auto-refresh every 60 seconds
    setInterval(() => {
      window.location.reload()
    }, 60000)
  </script>
{% endblock %}
