{% extends "base.html" %}

{% block title %}Strategies - Crypto Trading Bot{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Strategy Performance Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card shadow-sm">
                <div class="metric-label">Active Strategies</div>
                <div class="metric-value" id="activeStrategies">0</div>
                <div class="metric-change">
                    <i class="fas fa-robot"></i>
                    <span id="totalStrategies">0 Total</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card shadow-sm">
                <div class="metric-label">Best Performer</div>
                <div class="metric-value" id="bestStrategy">-</div>
                <div class="metric-change positive">
                    <i class="fas fa-trophy"></i>
                    <span id="bestPerformance">+0.00%</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card shadow-sm">
                <div class="metric-label">Total Strategy P&L</div>
                <div class="metric-value" id="totalStrategyPnL">$0.00</div>
                <div class="metric-change positive">
                    <i class="fas fa-chart-line"></i>
                    <span id="strategyPnLChange">+0.00%</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="metric-card shadow-sm">
                <div class="metric-label">Avg Win Rate</div>
                <div class="metric-value" id="avgWinRate">0%</div>
                <div class="metric-change">
                    <i class="fas fa-percentage"></i>
                    <span id="winRateRange">0% - 0%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Strategy List -->
        <div class="col-xl-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Trading Strategies
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshStrategies()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addStrategyModal">
                            <i class="fas fa-plus me-1"></i>
                            Add Strategy
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Strategy</th>
                                    <th>Status</th>
                                    <th>Symbols</th>
                                    <th>Trades</th>
                                    <th>Win Rate</th>
                                    <th>P&L</th>
                                    <th>Sharpe</th>
                                    <th>Last Signal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="strategiesTable">
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading strategies...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Performance Chart -->
        <div class="col-xl-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        Strategy Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="strategyComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Performance Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Strategy Performance Over Time
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="performanceStrategy" style="width: auto;">
                            <option value="">All Strategies</option>
                        </select>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-period="7d">7D</button>
                            <button type="button" class="btn btn-outline-primary" data-period="30d">30D</button>
                            <button type="button" class="btn btn-outline-primary" data-period="90d">90D</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Backtest Results -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Backtest Results
                    </h5>
                    <button class="btn btn-primary btn-sm" onclick="runBacktest()">
                        <i class="fas fa-play me-1"></i>
                        Run New Backtest
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Strategy</th>
                                    <th>Period</th>
                                    <th>Initial Capital</th>
                                    <th>Final Value</th>
                                    <th>Total Return</th>
                                    <th>Sharpe Ratio</th>
                                    <th>Max Drawdown</th>
                                    <th>Win Rate</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backtestTable">
                                <tr>
                                    <td colspan="10" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading backtest results...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Strategy Modal -->
<div class="modal fade" id="addStrategyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Strategy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStrategyForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Strategy Name</label>
                                <input type="text" class="form-control" id="strategyName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Strategy Type</label>
                                <select class="form-select" id="strategyType" required>
                                    <option value="">Select Type</option>
                                    <option value="moving_average">Moving Average</option>
                                    <option value="rsi">RSI</option>
                                    <option value="bollinger_bands">Bollinger Bands</option>
                                    <option value="macd">MACD</option>
                                    <option value="sma_crossover">SMA Crossover</option>
                                    <option value="ema_crossover">EMA Crossover</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Symbols</label>
                                <select class="form-select" id="strategySymbols" multiple>
                                    <!-- Will be populated dynamically -->
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple symbols</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Timeframe</label>
                                <select class="form-select" id="strategyTimeframe" required>
                                    <option value="1m">1 Minute</option>
                                    <option value="5m">5 Minutes</option>
                                    <option value="15m">15 Minutes</option>
                                    <option value="1h" selected>1 Hour</option>
                                    <option value="4h">4 Hours</option>
                                    <option value="1d">1 Day</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Risk Percentage (%)</label>
                                <input type="number" class="form-control" id="strategyRisk" value="1" min="0.1" max="10" step="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Positions</label>
                                <input type="number" class="form-control" id="strategyMaxPositions" value="5" min="1" max="20" required>
                            </div>
                        </div>
                    </div>
                    
                    <div id="strategyParameters" class="mt-3">
                        <!-- Strategy-specific parameters will be added here -->
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="strategyAutoStart">
                                <label class="form-check-label" for="strategyAutoStart">
                                    Start strategy immediately after creation
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStrategy()">Create Strategy</button>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Details Modal -->
<div class="modal fade" id="strategyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Strategy Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Strategy Information</h6>
                        <table class="table table-sm">
                            <tr><td>Name:</td><td><strong id="modalStrategyName">-</strong></td></tr>
                            <tr><td>Type:</td><td><strong id="modalStrategyType">-</strong></td></tr>
                            <tr><td>Status:</td><td><strong id="modalStrategyStatus">-</strong></td></tr>
                            <tr><td>Symbols:</td><td><strong id="modalStrategySymbols">-</strong></td></tr>
                            <tr><td>Timeframe:</td><td><strong id="modalStrategyTimeframe">-</strong></td></tr>
                            <tr><td>Risk %:</td><td><strong id="modalStrategyRisk">-</strong></td></tr>
                            <tr><td>Max Positions:</td><td><strong id="modalStrategyMaxPositions">-</strong></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Performance Metrics</h6>
                        <table class="table table-sm">
                            <tr><td>Total Trades:</td><td><strong id="modalTotalTrades">-</strong></td></tr>
                            <tr><td>Win Rate:</td><td><strong id="modalWinRate">-</strong></td></tr>
                            <tr><td>P&L:</td><td><strong id="modalPnL">-</strong></td></tr>
                            <tr><td>Sharpe Ratio:</td><td><strong id="modalSharpe">-</strong></td></tr>
                            <tr><td>Max Drawdown:</td><td><strong id="modalMaxDrawdown">-</strong></td></tr>
                            <tr><td>Avg Trade:</td><td><strong id="modalAvgTrade">-</strong></td></tr>
                            <tr><td>Last Signal:</td><td><strong id="modalLastSignal">-</strong></td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Strategy Parameters</h6>
                        <div id="modalStrategyParams" class="border rounded p-3 bg-light">
                            <!-- Parameters will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Recent Signals</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>Signal</th>
                                        <th>Price</th>
                                        <th>Confidence</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="modalRecentSignals">
                                    <tr><td colspan="6" class="text-center">Loading signals...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="editStrategy()">Edit</button>
                <button type="button" class="btn btn-success" onclick="startStrategy()" id="startStrategyBtn">Start</button>
                <button type="button" class="btn btn-danger" onclick="stopStrategy()" id="stopStrategyBtn">Stop</button>
                <button type="button" class="btn btn-info" onclick="backtestStrategy()">Backtest</button>
            </div>
        </div>
    </div>
</div>

<!-- Backtest Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Run Backtest</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="backtestForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Strategy</label>
                                <select class="form-select" id="backtestStrategy" required>
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="backtestStartDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="backtestEndDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Initial Capital</label>
                                <input type="number" class="form-control" id="backtestCapital" value="10000" min="1000" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Commission (%)</label>
                                <input type="number" class="form-control" id="backtestCommission" value="0.1" step="0.01" min="0" max="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Slippage (%)</label>
                                <input type="number" class="form-control" id="backtestSlippage" value="0.05" step="0.01" min="0" max="1">
                            </div>
                        </div>
                    </div>
                </form>
                <div id="backtestProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <small id="backtestStatus">Preparing backtest...</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startBacktest()" id="backtestSubmitBtn">Start Backtest</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let strategyComparisonChart, performanceChart;
let strategies = [];
let selectedStrategyId = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadStrategiesData();
    setupEventListeners();
    loadSymbolsForStrategy();
    setDefaultDates();
});

function initializeCharts() {
    // Strategy Comparison Chart
    const comparisonCtx = document.getElementById('strategyComparisonChart').getContext('2d');
    strategyComparisonChart = new Chart(comparisonCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#0d6efd', '#198754', '#dc3545', '#ffc107', '#0dcaf0',
                    '#6f42c1', '#fd7e14', '#20c997', '#6c757d', '#f8f9fa'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label;
                            const value = context.parsed;
                            return `${label}: ${formatPercentage(value)}`;
                        }
                    }
                }
            }
        }
    });

    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return formatPercentage(value);
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function loadStrategiesData() {
    // Load strategy summary
    fetch('/api/strategies/summary')
        .then(response => response.json())
        .then(data => {
            updateStrategySummary(data);
        })
        .catch(error => {
            console.error('Error loading strategy summary:', error);
        });

    // Load strategies
    loadStrategies();

    // Load backtest results
    loadBacktestResults();

    // Load performance chart
    loadStrategyPerformance('7d');
}

function updateStrategySummary(data) {
    document.getElementById('activeStrategies').textContent = data.active_strategies || 0;
    document.getElementById('bestStrategy').textContent = data.best_strategy || '-';
    document.getElementById('totalStrategyPnL').textContent = formatCurrency(data.total_pnl || 0);
    document.getElementById('avgWinRate').textContent = formatPercentage(data.avg_win_rate || 0);
    
    document.getElementById('totalStrategies').textContent = `${data.total_strategies || 0} Total`;
    document.getElementById('bestPerformance').textContent = formatPercentage(data.best_performance || 0);
    updateMetricChange('strategyPnLChange', data.pnl_change || 0);
    document.getElementById('winRateRange').textContent = 
        `${formatPercentage(data.min_win_rate || 0)} - ${formatPercentage(data.max_win_rate || 0)}`;
}

function loadStrategies() {
    fetch('/api/strategies')
        .then(response => response.json())
        .then(data => {
            strategies = data;
            updateStrategiesTable(data);
            updateStrategyComparison(data);
            updateStrategySelects(data);
        })
        .catch(error => {
            console.error('Error loading strategies:', error);
            document.getElementById('strategiesTable').innerHTML = 
                '<tr><td colspan="9" class="text-center text-danger">Error loading strategies</td></tr>';
        });
}

function updateStrategiesTable(strategies) {
    const tbody = document.getElementById('strategiesTable');
    
    if (strategies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No strategies configured</td></tr>';
        return;
    }
    
    tbody.innerHTML = strategies.map(strategy => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-robot me-2 text-primary"></i>
                    <div>
                        <strong>${strategy.name}</strong><br>
                        <small class="text-muted">${strategy.type}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge ${strategy.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                    ${strategy.status.toUpperCase()}
                </span>
            </td>
            <td>
                <small>${strategy.symbols.slice(0, 2).join(', ')}${strategy.symbols.length > 2 ? '...' : ''}</small>
            </td>
            <td>${strategy.total_trades || 0}</td>
            <td class="${strategy.win_rate >= 50 ? 'text-success' : 'text-danger'}">${formatPercentage(strategy.win_rate || 0)}</td>
            <td class="${strategy.pnl >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(strategy.pnl || 0)}</td>
            <td>${strategy.sharpe_ratio?.toFixed(2) || '-'}</td>
            <td>
                <small>${strategy.last_signal ? formatDateTime(strategy.last_signal) : 'No signals'}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewStrategy('${strategy.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-${strategy.status === 'active' ? 'danger' : 'success'}" 
                            onclick="toggleStrategy('${strategy.id}')">
                        <i class="fas fa-${strategy.status === 'active' ? 'stop' : 'play'}"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="deleteStrategy('${strategy.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function updateStrategyComparison(strategies) {
    const labels = strategies.map(s => s.name);
    const data = strategies.map(s => s.pnl_percent || 0);
    
    strategyComparisonChart.data.labels = labels;
    strategyComparisonChart.data.datasets[0].data = data;
    strategyComparisonChart.update();
}

function loadStrategyPerformance(period) {
    const strategy = document.getElementById('performanceStrategy').value;
    
    const params = new URLSearchParams({ period: period });
    if (strategy) params.append('strategy', strategy);
    
    fetch(`/api/strategies/performance?${params}`)
        .then(response => response.json())
        .then(data => {
            performanceChart.data.labels = data.timestamps;
            performanceChart.data.datasets = data.strategies.map((strategy, index) => ({
                label: strategy.name,
                data: strategy.performance,
                borderColor: getColor(index),
                backgroundColor: getColor(index, 0.1),
                fill: false,
                tension: 0.4
            }));
            performanceChart.update();
        })
        .catch(error => {
            console.error('Error loading strategy performance:', error);
        });
}

function loadBacktestResults() {
    fetch('/api/strategies/backtests')
        .then(response => response.json())
        .then(backtests => {
            updateBacktestTable(backtests);
        })
        .catch(error => {
            console.error('Error loading backtest results:', error);
            document.getElementById('backtestTable').innerHTML = 
                '<tr><td colspan="10" class="text-center text-danger">Error loading backtest results</td></tr>';
        });
}

function updateBacktestTable(backtests) {
    const tbody = document.getElementById('backtestTable');
    
    if (backtests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No backtest results available</td></tr>';
        return;
    }
    
    tbody.innerHTML = backtests.map(backtest => `
        <tr>
            <td><strong>${backtest.strategy_name}</strong></td>
            <td>${backtest.start_date} - ${backtest.end_date}</td>
            <td>${formatCurrency(backtest.initial_capital)}</td>
            <td>${formatCurrency(backtest.final_value)}</td>
            <td class="${backtest.total_return >= 0 ? 'text-success' : 'text-danger'}">
                ${formatPercentage(backtest.total_return)}
            </td>
            <td>${backtest.sharpe_ratio?.toFixed(2) || '-'}</td>
            <td class="text-danger">${formatPercentage(backtest.max_drawdown || 0)}</td>
            <td>${formatPercentage(backtest.win_rate || 0)}</td>
            <td>${formatDateTime(backtest.created_at)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewBacktestDetails('${backtest.id}')">
                    <i class="fas fa-chart-line"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function setupEventListeners() {
    // Strategy type change
    document.getElementById('strategyType').addEventListener('change', function() {
        updateStrategyParameters(this.value);
    });

    // Performance period buttons
    document.querySelectorAll('[data-period]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('[data-period]').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            loadStrategyPerformance(this.dataset.period);
        });
    });

    // Performance strategy filter
    document.getElementById('performanceStrategy').addEventListener('change', function() {
        const activePeriod = document.querySelector('[data-period].active').dataset.period;
        loadStrategyPerformance(activePeriod);
    });
}

function updateStrategyParameters(strategyType) {
    const parametersDiv = document.getElementById('strategyParameters');
    
    let parametersHTML = '<h6>Strategy Parameters</h6>';
    
    switch(strategyType) {
        case 'moving_average':
            parametersHTML += `
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Period</label>
                        <input type="number" class="form-control" name="period" value="20" min="5" max="200">
                    </div>
                    <div class="col-6">
                        <label class="form-label">MA Type</label>
                        <select class="form-select" name="ma_type">
                            <option value="sma">Simple MA</option>
                            <option value="ema">Exponential MA</option>
                        </select>
                    </div>
                </div>
            `;
            break;
        case 'rsi':
            parametersHTML += `
                <div class="row">
                    <div class="col-4">
                        <label class="form-label">Period</label>
                        <input type="number" class="form-control" name="period" value="14" min="5" max="50">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Overbought Level</label>
                        <input type="number" class="form-control" name="overbought" value="70" min="60" max="90">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Oversold Level</label>
                        <input type="number" class="form-control" name="oversold" value="30" min="10" max="40">
                    </div>
                </div>
            `;
            break;
        case 'bollinger_bands':
            parametersHTML += `
                <div class="row">
                    <div class="col-4">
                        <label class="form-label">Period</label>
                        <input type="number" class="form-control" name="period" value="20" min="10" max="50">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Standard Deviations</label>
                        <input type="number" class="form-control" name="std_dev" value="2" min="1" max="3" step="0.1">
                    </div>
                    <div class="col-4">
                        <label class="form-label">MA Type</label>
                        <select class="form-select" name="ma_type">
                            <option value="sma">Simple MA</option>
                            <option value="ema">Exponential MA</option>
                        </select>
                    </div>
                </div>
            `;
            break;
        case 'macd':
            parametersHTML += `
                <div class="row">
                    <div class="col-4">
                        <label class="form-label">Fast Period</label>
                        <input type="number" class="form-control" name="fast_period" value="12" min="5" max="20">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Slow Period</label>
                        <input type="number" class="form-control" name="slow_period" value="26" min="20" max="50">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Signal Period</label>
                        <input type="number" class="form-control" name="signal_period" value="9" min="5" max="15">
                    </div>
                </div>
            `;
            break;
        case 'sma_crossover':
        case 'ema_crossover':
            parametersHTML += `
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Fast Period</label>
                        <input type="number" class="form-control" name="fast_period" value="10" min="5" max="50">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Slow Period</label>
                        <input type="number" class="form-control" name="slow_period" value="30" min="20" max="200">
                    </div>
                </div>
            `;
            break;
        case 'custom':
            parametersHTML += `
                <div class="mb-3">
                    <label class="form-label">Custom Parameters (JSON)</label>
                    <textarea class="form-control" name="custom_params" rows="4" placeholder='{"param1": "value1", "param2": "value2"}'></textarea>
                </div>
            `;
            break;
    }
    
    parametersDiv.innerHTML = parametersHTML;
}

function loadSymbolsForStrategy() {
    fetch('/api/symbols')
        .then(response => response.json())
        .then(symbols => {
            const symbolSelect = document.getElementById('strategySymbols');
            symbolSelect.innerHTML = symbols.map(symbol => 
                `<option value="${symbol}">${symbol}</option>`
            ).join('');
        })
        .catch(error => {
            console.error('Error loading symbols:', error);
        });
}

function updateStrategySelects(strategies) {
    const performanceSelect = document.getElementById('performanceStrategy');
    const backtestSelect = document.getElementById('backtestStrategy');
    
    // Update performance strategy filter
    performanceSelect.innerHTML = '<option value="">All Strategies</option>';
    strategies.forEach(strategy => {
        performanceSelect.innerHTML += `<option value="${strategy.id}">${strategy.name}</option>`;
    });
    
    // Update backtest strategy selector
    backtestSelect.innerHTML = '';
    strategies.forEach(strategy => {
        backtestSelect.innerHTML += `<option value="${strategy.id}">${strategy.name}</option>`;
    });
}

function saveStrategy() {
    const formData = {
        name: document.getElementById('strategyName').value,
        type: document.getElementById('strategyType').value,
        symbols: Array.from(document.getElementById('strategySymbols').selectedOptions).map(opt => opt.value),
        timeframe: document.getElementById('strategyTimeframe').value,
        risk_percentage: parseFloat(document.getElementById('strategyRisk').value),
        max_positions: parseInt(document.getElementById('strategyMaxPositions').value),
        auto_start: document.getElementById('strategyAutoStart').checked,
        parameters: {}
    };

    // Collect strategy parameters
    const paramInputs = document.querySelectorAll('#strategyParameters input, #strategyParameters select, #strategyParameters textarea');
    paramInputs.forEach(input => {
        if (input.name) {
            formData.parameters[input.name] = input.type === 'number' ? parseFloat(input.value) : input.value;
        }
    });

    fetch('/api/strategies', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Strategy created successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addStrategyModal')).hide();
            document.getElementById('addStrategyForm').reset();
            document.getElementById('strategyParameters').innerHTML = '';
            loadStrategiesData();
        } else {
            showToast('Failed to create strategy: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating strategy:', error);
        showToast('Failed to create strategy', 'error');
    });
}

function viewStrategy(strategyId) {
    selectedStrategyId = strategyId;
    const strategy = strategies.find(s => s.id === strategyId);
    if (!strategy) return;

    // Populate modal
    document.getElementById('modalStrategyName').textContent = strategy.name;
    document.getElementById('modalStrategyType').textContent = strategy.type;
    document.getElementById('modalStrategyStatus').textContent = strategy.status.toUpperCase();
    document.getElementById('modalStrategySymbols').textContent = strategy.symbols.join(', ');
    document.getElementById('modalStrategyTimeframe').textContent = strategy.timeframe;
    document.getElementById('modalStrategyRisk').textContent = strategy.risk_percentage + '%';
    document.getElementById('modalStrategyMaxPositions').textContent = strategy.max_positions;
    
    document.getElementById('modalTotalTrades').textContent = strategy.total_trades || 0;
    document.getElementById('modalWinRate').textContent = formatPercentage(strategy.win_rate || 0);
    document.getElementById('modalPnL').textContent = formatCurrency(strategy.pnl || 0);
    document.getElementById('modalPnL').className = strategy.pnl >= 0 ? 'text-success' : 'text-danger';
    document.getElementById('modalSharpe').textContent = strategy.sharpe_ratio?.toFixed(2) || '-';
    document.getElementById('modalMaxDrawdown').textContent = formatPercentage(strategy.max_drawdown || 0);
    document.getElementById('modalAvgTrade').textContent = formatCurrency(strategy.avg_trade || 0);
    document.getElementById('modalLastSignal').textContent = strategy.last_signal ? formatDateTime(strategy.last_signal) : 'No signals';
    
    // Update button states
    document.getElementById('startStrategyBtn').style.display = strategy.status === 'active' ? 'none' : 'inline-block';
    document.getElementById('stopStrategyBtn').style.display = strategy.status === 'active' ? 'inline-block' : 'none';
    
    // Load strategy parameters and recent signals
    loadStrategyDetails(strategyId);
    
    new bootstrap.Modal(document.getElementById('strategyModal')).show();
}

function loadStrategyDetails(strategyId) {
    // Load parameters
    fetch(`/api/strategies/${strategyId}/parameters`)
        .then(response => response.json())
        .then(params => {
            let paramsHTML = '';
            for (const [key, value] of Object.entries(params)) {
                paramsHTML += `<strong>${key}:</strong> ${value}<br>`;
            }
            document.getElementById('modalStrategyParams').innerHTML = paramsHTML || 'No parameters configured';
        })
        .catch(error => {
            console.error('Error loading strategy parameters:', error);
        });

    // Load recent signals
    fetch(`/api/strategies/${strategyId}/signals`)
        .then(response => response.json())
        .then(signals => {
            const tbody = document.getElementById('modalRecentSignals');
            if (signals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No recent signals</td></tr>';
                return;
            }
            
            tbody.innerHTML = signals.map(signal => `
                <tr>
                    <td><small>${formatDateTime(signal.timestamp)}</small></td>
                    <td><strong>${signal.symbol}</strong></td>
                    <td><span class="badge ${signal.signal === 'buy' ? 'bg-success' : 'bg-danger'}">${signal.signal.toUpperCase()}</span></td>
                    <td>${formatCurrency(signal.price)}</td>
                    <td>${signal.confidence ? (signal.confidence * 100).toFixed(1) + '%' : '-'}</td>
                    <td><span class="badge ${signal.executed ? 'bg-success' : 'bg-warning'}">${signal.executed ? 'Executed' : 'Pending'}</span></td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading strategy signals:', error);
        });
}

function toggleStrategy(strategyId) {
    const strategy = strategies.find(s => s.id === strategyId);
    if (!strategy) return;
    
    const action = strategy.status === 'active' ? 'stop' : 'start';
    
    fetch(`/api/strategies/${strategyId}/${action}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Strategy ${action}ed successfully`, 'success');
                loadStrategiesData();
            } else {
                showToast(`Failed to ${action} strategy: ` + data.error, 'error');
            }
        })
        .catch(error => {
            console.error(`Error ${action}ing strategy:`, error);
            showToast(`Failed to ${action} strategy`, 'error');
        });
}

function startStrategy() {
    if (selectedStrategyId) {
        toggleStrategy(selectedStrategyId);
        bootstrap.Modal.getInstance(document.getElementById('strategyModal')).hide();
    }
}

function stopStrategy() {
    if (selectedStrategyId) {
        toggleStrategy(selectedStrategyId);
        bootstrap.Modal.getInstance(document.getElementById('strategyModal')).hide();
    }
}

function deleteStrategy(strategyId) {
    if (!confirm('Are you sure you want to delete this strategy? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/strategies/${strategyId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Strategy deleted successfully', 'success');
                loadStrategiesData();
            } else {
                showToast('Failed to delete strategy: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting strategy:', error);
            showToast('Failed to delete strategy', 'error');
        });
}

function editStrategy() {
    // TODO: Implement strategy editing
    showToast('Strategy editing coming soon', 'info');
}

function backtestStrategy() {
    if (selectedStrategyId) {
        document.getElementById('backtestStrategy').value = selectedStrategyId;
        bootstrap.Modal.getInstance(document.getElementById('strategyModal')).hide();
        new bootstrap.Modal(document.getElementById('backtestModal')).show();
    }
}

function runBacktest() {
    new bootstrap.Modal(document.getElementById('backtestModal')).show();
}

function setDefaultDates() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setMonth(startDate.getMonth() - 3);
    
    document.getElementById('backtestEndDate').value = endDate.toISOString().split('T')[0];
    document.getElementById('backtestStartDate').value = startDate.toISOString().split('T')[0];
}

function startBacktest() {
    const formData = {
        strategy_id: document.getElementById('backtestStrategy').value,
        start_date: document.getElementById('backtestStartDate').value,
        end_date: document.getElementById('backtestEndDate').value,
        initial_capital: parseFloat(document.getElementById('backtestCapital').value),
        commission: parseFloat(document.getElementById('backtestCommission').value) / 100,
        slippage: parseFloat(document.getElementById('backtestSlippage').value) / 100
    };

    // Show progress
    document.getElementById('backtestProgress').style.display = 'block';
    document.getElementById('backtestSubmitBtn').disabled = true;
    
    fetch('/api/strategies/backtest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Backtest started successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('backtestModal')).hide();
            
            // Poll for backtest completion
            pollBacktestStatus(data.backtest_id);
        } else {
            showToast('Failed to start backtest: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error starting backtest:', error);
        showToast('Failed to start backtest', 'error');
    })
    .finally(() => {
        document.getElementById('backtestProgress').style.display = 'none';
        document.getElementById('backtestSubmitBtn').disabled = false;
    });
}

function pollBacktestStatus(backtestId) {
    const pollInterval = setInterval(() => {
        fetch(`/api/strategies/backtest/${backtestId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    showToast('Backtest completed successfully', 'success');
                    loadBacktestResults();
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    showToast('Backtest failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error polling backtest status:', error);
                clearInterval(pollInterval);
            });
    }, 5000);
}

function viewBacktestDetails(backtestId) {
    // TODO: Implement backtest details view
    showToast('Backtest details view coming soon', 'info');
}

function refreshStrategies() {
    loadStrategiesData();
    showToast('Strategies refreshed', 'success');
}

function getColor(index, alpha = 1) {
    const colors = [
        `rgba(13, 110, 253, ${alpha})`,
        `rgba(25, 135, 84, ${alpha})`,
        `rgba(220, 53, 69, ${alpha})`,
        `rgba(255, 193, 7, ${alpha})`,
        `rgba(13, 202, 240, ${alpha})`,
        `rgba(111, 66, 193, ${alpha})`,
        `rgba(253, 126, 20, ${alpha})`,
        `rgba(32, 201, 151, ${alpha})`,
        `rgba(108, 117, 125, ${alpha})`,
        `rgba(248, 249, 250, ${alpha})`
    ];
    return colors[index % colors.length];
}
</script>
{% endblock %}
