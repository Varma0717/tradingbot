<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}
        Crypto Trading Bot Dashboard
      {% endblock %}
    </title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link href="/static/css/dashboard.css" rel="stylesheet" />

    <style>
      :root {
        --primary-color: #2563eb;
        --success-color: #16a34a;
        --danger-color: #dc2626;
        --warning-color: #d97706;
        --info-color: #0891b2;
        --dark-color: #1f2937;
        --light-color: #f8fafc;
      }
      
      body {
        background-color: var(--light-color);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      .sidebar {
        background: linear-gradient(180deg, var(--dark-color) 0%, #374151 100%);
        min-height: 100vh;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      
      .sidebar .nav-link {
        color: #d1d5db;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin: 0.25rem 0;
        transition: all 0.3s ease;
      }
      
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background-color: var(--primary-color);
        color: white;
        transform: translateX(5px);
      }
      
      .main-content {
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin: 1rem;
        padding: 2rem;
      }
      
      .status-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, #3b82f6 100%);
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      }
      
      .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--primary-color);
        transition: transform 0.3s ease;
      }
      
      .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }
      
      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--dark-color);
      }
      
      .metric-label {
        color: #6b7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .loading-placeholder {
        color: #9ca3af;
        animation: pulse 1.5s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      
      .profit {
        color: var(--success-color);
      }
      
      .loss {
        color: var(--danger-color);
      }
      
      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 600;
        font-size: 0.875rem;
      }
      
      .status-running {
        background-color: #dcfce7;
        color: var(--success-color);
      }
      
      .status-stopped {
        background-color: #fee2e2;
        color: var(--danger-color);
      }
      
      .status-error {
        background-color: #fef3c7;
        color: var(--warning-color);
      }
      
      .chart-container {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 1rem;
      }
      
      .btn-custom {
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      .btn-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      
      .table-custom {
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .table-custom th {
        background-color: var(--dark-color);
        color: white;
        border: none;
        padding: 1rem;
      }
      
      .table-custom td {
        padding: 1rem;
        border-color: #f3f4f6;
      }
      
      .navbar-custom {
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 0 0 1rem 1rem;
      }
      
      .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      
      .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
      }
      
      .connection-connected {
        background-color: #dcfce7;
        color: var(--success-color);
        border: 1px solid var(--success-color);
      }
      
      .connection-disconnected {
        background-color: #fee2e2;
        color: var(--danger-color);
        border: 1px solid var(--danger-color);
      }
    </style>
  </head>
  <body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connection-disconnected">
      <i class="bi bi-wifi-off"></i> Disconnected
    </div>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 p-0">
          <div class="sidebar">
            <div class="p-4">
              <h4 class="text-white mb-4">
                <i class="bi bi-robot text-primary"></i>
                Trading Bot
              </h4>
              <nav class="nav flex-column">
                <a class="nav-link {% if request.url.path == '/' %}active{% endif %}" href="/">
                  <i class="bi bi-speedometer2 me-2"></i>
                  Dashboard
                </a>
                <a class="nav-link {% if request.url.path == '/portfolio' %}active{% endif %}" href="/portfolio">
                  <i class="bi bi-wallet2 me-2"></i>
                  Portfolio
                </a>
                <a class="nav-link {% if request.url.path == '/trades' %}active{% endif %}" href="/trades">
                  <i class="bi bi-arrow-left-right me-2"></i>
                  Trades
                </a>
                <a class="nav-link {% if request.url.path == '/strategies' %}active{% endif %}" href="/strategies">
                  <i class="bi bi-graph-up me-2"></i>
                  Strategies
                </a>
                <a class="nav-link {% if request.url.path == '/grid-dca' %}active{% endif %}" href="/grid-dca">
                  <i class="bi bi-grid-3x3-gap me-2"></i>
                  Grid DCA
                </a>
                <a class="nav-link {% if request.url.path == '/settings' %}active{% endif %}" href="/settings">
                  <i class="bi bi-gear me-2"></i>
                  Settings
                </a>
              </nav>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-10">
          <!-- Top Navigation -->
          <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container-fluid">
              <span class="navbar-brand mb-0 h1">
                {% block page_title %}
                  Dashboard
                {% endblock %}
              </span>
              <div class="d-flex align-items-center">
                <span class="text-muted me-3">{{ current_time }}</span>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="#" onclick="refreshData()"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="/api/docs" target="_blank"><i class="bi bi-code-square"></i> API Docs</a>
                    </li>
                    <li>
                      <hr class="dropdown-divider" />
                    </li>
                    <li>
                      <a class="dropdown-item text-danger" href="#" onclick="confirmAction('stop')"><i class="bi bi-stop-circle"></i> Stop Bot</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </nav>

          <!-- Page Content -->
          <div class="main-content">
            {% block content %}

            {% endblock %}
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- WebSocket Connection -->
    <script>
      let ws = null
      let reconnectInterval = null
      
      function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
        const wsUrl = `${protocol}//${window.location.host}/ws/realtime`
      
        ws = new WebSocket(wsUrl)
      
        ws.onopen = function () {
          console.log('WebSocket connected')
          updateConnectionStatus(true)
          if (reconnectInterval) {
            clearInterval(reconnectInterval)
            reconnectInterval = null
          }
        }
      
        ws.onmessage = function (event) {
          const data = JSON.parse(event.data)
          handleWebSocketMessage(data)
        }
      
        ws.onclose = function () {
          console.log('WebSocket disconnected')
          updateConnectionStatus(false)
          // Attempt to reconnect every 5 seconds
          if (!reconnectInterval) {
            reconnectInterval = setInterval(connectWebSocket, 5000)
          }
        }
      
        ws.onerror = function (error) {
          console.error('WebSocket error:', error)
          updateConnectionStatus(false)
        }
      }
      
      function updateConnectionStatus(connected) {
        const statusEl = document.getElementById('connectionStatus')
        if (connected) {
          statusEl.className = 'connection-status connection-connected'
          statusEl.innerHTML = '<i class="bi bi-wifi"></i> Connected'
        } else {
          statusEl.className = 'connection-status connection-disconnected'
          statusEl.innerHTML = '<i class="bi bi-wifi-off"></i> Disconnected'
        }
      }
      
      function handleWebSocketMessage(data) {
        // Handle different message types
        switch (data.type) {
          case 'initial_data':
          case 'periodic_update':
            updateDashboardData(data.data)
            break
          case 'broadcast_update':
            updateDashboardData(data.data)
            break
          case 'error':
            console.error('WebSocket error:', data.message)
            break
        }
      }
      
      function updateDashboardData(data) {
        // Update dashboard elements with real-time data
        if (typeof updatePortfolioData === 'function') {
          updatePortfolioData(data.portfolio)
        }
        if (typeof updateOrdersData === 'function') {
          updateOrdersData(data.orders)
        }
        if (typeof updateStrategiesData === 'function') {
          updateStrategiesData(data.strategies)
        }
      }
      
      function refreshData() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: 'request_data',
              data_type: 'all'
            })
          )
        } else {
          location.reload()
        }
      }
      
      function confirmAction(action) {
        if (confirm(`Are you sure you want to ${action} the trading bot?`)) {
          fetch(`/api/control/${action}`, { method: 'POST' })
            .then((response) => {
              if (response.ok) {
                showNotification(`Bot ${action} command executed successfully`, 'success')
                // Reload page after a short delay to show notification
                setTimeout(() => location.reload(), 1000)
              } else {
                response
                  .json()
                  .then((data) => {
                    showNotification(`Action failed: ${data.detail || 'Unknown error'}`, 'error')
                  })
                  .catch(() => {
                    showNotification('Action failed. Please try again.', 'error')
                  })
              }
            })
            .catch((error) => {
              console.error('Error:', error)
              showNotification('Network error. Please check your connection.', 'error')
            })
        }
      }
      
      // Notification system
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div')
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;'
        notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              `
        document.body.appendChild(notification)
      
        // Auto-remove after 4 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove()
          }
        }, 4000)
      }
      
      // Utility functions
      function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(value)
      }
      
      function formatPercentage(value) {
        return new Intl.NumberFormat('en-US', {
          style: 'percent',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
          signDisplay: 'always'
        }).format(value / 100)
      }
      
      function formatNumber(value, decimals = 2) {
        return new Intl.NumberFormat('en-US', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        }).format(value)
      }
      
      // Initialize WebSocket connection when page loads
      document.addEventListener('DOMContentLoaded', function () {
        connectWebSocket()
      })
    </script>

    {% block scripts %}

    {% endblock %}
  </body>
</html>
