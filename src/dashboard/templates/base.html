<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}
        Crypto Trading Bot Dashboard
      {% endblock %}
    </title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link href="/static/css/style.css" rel="stylesheet" />

    <style>
      .pulse {
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.05);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      .paper-trading-indicator {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: bold;
      }
    </style>

    {% block head %}

    {% endblock %}
  </head>
  <body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connection-disconnected">
      <i class="bi bi-wifi-off"></i> Disconnected
    </div>

    <div class="container-fluid p-0">
      <div class="row g-0">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle btn btn-primary d-md-none position-fixed" style="top: 1rem; left: 1rem; z-index: 1001; display: none;" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <div class="brand">
            <i class="bi bi-robot"></i>
            Trading Bot
          </div>
          <nav class="nav flex-column p-3">
            <a class="nav-link {% if request.url.path == '/' %}active{% endif %}" href="/">
              <i class="bi bi-speedometer2"></i>
              Dashboard
            </a>
            <a class="nav-link {% if request.url.path == '/portfolio' %}active{% endif %}" href="/portfolio">
              <i class="bi bi-wallet2"></i>
              Portfolio
            </a>
            <a class="nav-link {% if request.url.path == '/trades' %}active{% endif %}" href="/trades">
              <i class="bi bi-arrow-left-right"></i>
              Trades
            </a>
            <a class="nav-link {% if request.url.path == '/grid-dca' %}active{% endif %}" href="/grid-dca">
              <i class="bi bi-grid-3x3-gap"></i>
              Grid DCA Strategy
              <span class="badge bg-success ms-1 pulse" id="paperTradingBadge">LIVE</span>
            </a>
            <a class="nav-link {% if request.url.path == '/settings' %}active{% endif %}" href="/settings">
              <i class="bi bi-gear"></i>
              Settings
            </a>
          </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
          <!-- Top Navigation -->
          <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4">
            <div class="container-fluid">
              <h5 class="mb-0">
                {% block page_title %}
                  Dashboard
                {% endblock %}
              </h5>
              <div class="d-flex align-items-center">
                <!-- Data Mode Toggle -->
                <div class="me-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="dataModeToggle" checked>
                    <label class="form-check-label fw-bold text-success" for="dataModeToggle" id="dataModeLabel">
                      <i class="bi bi-broadcast-pin me-1"></i>Live Trading
                    </label>
                  </div>
                </div>
                <span class="text-muted me-3">{{ current_time }}</span>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle me-1"></i>
                    Account
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="/settings"><i class="bi bi-gear me-2"></i>Settings</a>
                    </li>
                    <li>
                      <hr class="dropdown-divider" />
                    </li>
                    <li>
                      <a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
                    </li>
                  </ul>
                </div>
                <div class="dropdown ms-2">
                  <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="#" onclick="refreshData()"><i class="bi bi-arrow-clockwise me-2"></i> Refresh</a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="/api/docs" target="_blank"><i class="bi bi-code-square me-2"></i> API Docs</a>
                    </li>
                    <li>
                      <hr class="dropdown-divider" />
                    </li>
                    <li>
                      <a class="dropdown-item text-danger" href="#" onclick="confirmAction('stop')"><i class="bi bi-stop-circle me-2"></i> Stop Bot</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </nav>

          <!-- Page Content -->
          <div class="content-wrapper">
            <div class="container-fluid">
              {% block content %}

              {% endblock %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script src="/static/js/paper-trading.js"></script>
    <script src="/static/js/dashboard.js"></script>

    <!-- Essential Utility Functions -->
    <script>
        // Formatting functions used across all pages
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return '$0.00';
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) {
                return '0';
            }
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        function formatPercentage(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return '0.00%';
            }
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).format(date);
            } catch (e) {
                return dateString;
            }
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${diffDays}d ago`;
            } catch (e) {
                return dateString;
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast-container .toast');
            existingToasts.forEach(toast => {
                toast.remove();
            });

            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            // Create toast element
            const toastId = 'toast-' + Date.now();
            const bgClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-info';

            const iconClass = {
                'success': 'bi-check-circle-fill',
                'error': 'bi-exclamation-triangle-fill',
                'warning': 'bi-exclamation-triangle-fill',
                'info': 'bi-info-circle-fill'
            }[type] || 'bi-info-circle-fill';

            const toastHtml = `
                <div class="toast ${bgClass} text-white" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgClass} text-white border-0">
                        <i class="bi ${iconClass} me-2"></i>
                        <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            // Initialize and show toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: type === 'error' ? 5000 : 3000
            });
            toast.show();

            // Remove from DOM after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Metric change update function
        function updateMetricChange(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const isPositive = value > 0;
            const isNegative = value < 0;

            // Update classes
            element.parentElement.classList.remove('positive', 'negative');
            if (isPositive) {
                element.parentElement.classList.add('positive');
            } else if (isNegative) {
                element.parentElement.classList.add('negative');
            }

            // Update icon
            const icon = element.parentElement.querySelector('i');
            if (icon) {
                icon.className = isPositive ? 'fas fa-arrow-up' : 
                                isNegative ? 'fas fa-arrow-down' : 'fas fa-minus';
            }

            // Update text
            const sign = isPositive ? '+' : '';
            element.textContent = `${sign}${formatPercentage(value / 100)}`;
        }

        // WebSocket connection manager
        function initializeWebSocket() {
            if (window.location.protocol === 'https:') {
                window.ws = new WebSocket(`wss://${window.location.host}/ws/realtime`);
            } else {
                window.ws = new WebSocket(`ws://${window.location.host}/ws/realtime`);
            }

            window.ws.onopen = function() {
                console.log('WebSocket connected');
            };

            window.ws.onclose = function() {
                console.log('WebSocket disconnected');
                // Reconnect after 5 seconds
                setTimeout(initializeWebSocket, 5000);
            };

            window.ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // Initialize WebSocket and Data Mode Manager on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            
            // Initialize data mode manager after a short delay to ensure DOM is ready
            setTimeout(() => {
                if (window.dataModeManager) {
                    window.dataModeManager.init();
                }
            }, 100);
        });

        // Paper trading indicator functions
        function showPaperTradingIndicatorOnTrades() {
            // This function is called from individual pages
            const indicator = document.getElementById('paperTradingIndicator');
            if (indicator) {
                indicator.style.display = 'inline-block';
            }
        }

        // Global error handler for fetch requests
        function handleFetchError(error, context = '') {
            console.error(`Error in ${context}:`, error);
            showToast(`Error: ${error.message || 'Network request failed'}`, 'error');
        }

        // Safe fetch wrapper
        function safeFetch(url, options = {}) {
            return fetch(url, options)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    handleFetchError(error, url);
                    throw error;
                });
        }

        // Global Data Mode Manager
        class DataModeManager {
            constructor() {
                this.isLiveMode = localStorage.getItem('tradingDataMode') !== 'paper';
                this.listeners = [];
                this.init();
            }

            init() {
                // Set up toggle
                const toggle = document.getElementById('dataModeToggle');
                const label = document.getElementById('dataModeLabel');
                
                if (toggle) {
                    toggle.checked = this.isLiveMode;
                    this.updateToggleLabel();
                    
                    toggle.addEventListener('change', (e) => {
                        this.setMode(e.target.checked);
                    });
                }
            }

            setMode(isLive) {
                const oldMode = this.isLiveMode;
                this.isLiveMode = isLive;
                localStorage.setItem('tradingDataMode', isLive ? 'live' : 'paper');
                
                this.updateToggleLabel();
                
                // Show toast notification
                const mode = isLive ? 'Live Trading' : 'Paper Trading';
                showToast(`Switched to ${mode} mode`, 'info');
                
                // Notify all listeners
                this.listeners.forEach(callback => {
                    try {
                        callback(this.isLiveMode, oldMode !== this.isLiveMode);
                    } catch (error) {
                        console.error('Error in data mode listener:', error);
                    }
                });
            }

            updateToggleLabel() {
                const label = document.getElementById('dataModeLabel');
                if (label) {
                    if (this.isLiveMode) {
                        label.innerHTML = '<i class="bi bi-broadcast-pin me-1"></i>Live Trading';
                        label.className = 'form-check-label fw-bold text-success';
                    } else {
                        label.innerHTML = '<i class="bi bi-laptop me-1"></i>Paper Trading';
                        label.className = 'form-check-label fw-bold text-warning';
                    }
                }
            }

            isLiveModeActive() {
                return this.isLiveMode;
            }

            isPaperModeActive() {
                return !this.isLiveMode;
            }

            onModeChange(callback) {
                this.listeners.push(callback);
                // Call immediately with current state
                callback(this.isLiveMode, false);
            }

            removeModeChangeListener(callback) {
                const index = this.listeners.indexOf(callback);
                if (index > -1) {
                    this.listeners.splice(index, 1);
                }
            }
        }

        // Global instance
        window.dataModeManager = new DataModeManager();

        // Helper function for pages to get appropriate data
        function getDataForCurrentMode(liveData, paperData) {
            if (window.dataModeManager.isLiveModeActive()) {
                return liveData || {};
            } else {
                return paperData || {};
            }
        }

        // Helper function to add data source indicators
        function addDataSourceIndicator(value, hasRealData, hasPaperData) {
            if (window.dataModeManager.isLiveModeActive()) {
                if (hasRealData) {
                    return `${value} <small class="text-success">(Live)</small>`;
                } else {
                    return `${value} <small class="text-muted">(No Data)</small>`;
                }
            } else {
                if (hasPaperData) {
                    return `${value} <small class="text-warning">(Paper)</small>`;
                } else {
                    return `${value} <small class="text-muted">(No Data)</small>`;
                }
            }
        }
    </script>

    {% block scripts %}

    {% endblock %}
  </body>
</html>
